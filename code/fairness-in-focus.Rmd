---
title: "Fairness In Focus Code"
author: "Jacob Ford"
date: "2024-07-08"
output: html_document
---








```{r message=FALSE, warning=FALSE, include=FALSE}
library(rmdformats)
library(ggplot2)
library(dplyr)
library(readxl)
library(reshape)
require(gridExtra)
library(kableExtra)
library(missRanger)
library(formattable)
source("./util/helper_functions.R")

library(plotly)
options(scipen = 100)


# ========================================================================================
# Sample data comes from the joined Experion + Axciom Data used to create the EnergyScore. 
# 
# For efficiency, only relevant variables needed for this analysis are included in the 'full_data.csv'. These include unique ID (RECORD_NB), tag for 90 days late (DPD90_KEYCD) and a related unused definition (DPD90_KEYCD_24), FICO Scores (FICOCLV8_SCORE), income (axciom7641_1), education status (axciom7650_1), homeowner status, (axciom7606_1), race (axciom9528) and a race with collapsed categories (axiom3101), along with the EnergyScore, which is a probability of late payment within 90 days. Note, the 90 days late is the key DV. 
#
# ========================================================================================


## Race = axciom9528
# Race Code - 1st Individual
# A = Asian
# B = Black
# C = Chinese
# H = Hispanic
# I = American Indian
# N = Japanese
# O = Other
# P = Portuguese
# W = White


##Race - Low Detail axiom3101
# Race Code (Low Detail)
# A = A - Asian
# B = B - African American
# H = H - Hispanic
# W = W - White/Other



## Homeowner = `axciom7606_1`

# OwnerRenter
# O = Home Owner
# R = Renter

## Income = axciom7641_1

# Income
# 1 = Less than $15,000
# 2 = $15,000 - $19,999
# 3 = $20,000 - $29,999
# 4 = $30,000 - $39,999
# 5 = $40,000 - $49,999
# 6 = $50,000 - $74,999
# 7 = $75,000 - $99,999
# 8 = $100,000 - $124,999
# 9 = Greater than $124,999


## Education = axciom7650_1

# Education
# 1 = Completed High School
# 2 = Completed College
# 3 = Completed Graduate School
# 4 = Attended Vocational/Technical


sample_data <- read.csv('/Users/jacobford/Library/CloudStorage/GoogleDrive-jake@solstice.us/Shared drives/*Solstice | Shared Project/The EnergyScore/Google Bias Fairness Analysis/Master ES Dataset/Stata/full_data.csv')

output = read.csv("/Users/jacobford/Library/CloudStorage/GoogleDrive-jake@solstice.us/My Drive/EnergyScore/Bias/Full Dataset/Archive/EnergyScore_output_jf_test_4.5.22.csv", header=FALSE)
names(output)[1] <- "Prob_Not_Def"
names(output)[2] <- "Prob_Def"

output$RECORD_NB <- sample_data$RECORD_NB

joined <- merge(sample_data,output, by="RECORD_NB")
drop(sample_data)
drop(output)




# Note: the variable used in the white paper is axciom9528, which has a large 'other' population, looks to have been combined with general white population in the other race category, axiom3101; pros and cons to each, however to avoid simply lumping 'other' into white, and to maintain consistency with previous work, will use axciom9528 

joined <- joined %>% 
  mutate( 
    Race = case_when(
      axciom9528 == "A" | axciom9528 == "C" | axciom9528 == "N"  ~ "Asian" ,
      axciom9528 == "B" ~ "Black",
      axciom9528 == "H" ~ "Hispanic",
      axciom9528 == "W" ~ "White"),
    Race2 = case_when(
      axciom3101 =="A" ~ "Asian",
      axciom3101 == "B" ~ "Black",
      axciom3101 == "H" ~ "Hispanic",
      axciom3101 == "W" ~ "White"),
    Education = case_when(
      axciom7650_1 == 1 ~ "High School",
      axciom7650_1 == 2 ~ "College",
      axciom7650_1 == 3 ~ "Graduate School", 
      axciom7650_1 == 4 ~ "Vocational/Technical"
    ),
    EnergyScore = Prob_Not_Def*100,
    dummy=1,
  HomeOwnership = case_when(
      axciom7606_1 =="O" ~ "Own",
      axciom7606_1 == "R" ~ "Rent"
    ))


joined <- joined %>%
  mutate(Income = case_when(
    axciom7641_1 <=4 ~ "Low",
    axciom7641_1 == 5 | axciom7641_1 ==6 ~ "Medium",
    axciom7641_1 > 6 ~ "High"
  )) 

joined$Income <- factor(joined$Income, labels=c("Low", "Medium", "High"))

race_data <- joined %>%
  filter(!is.na(Race))

```




### Table 1



```{r desctab, echo=FALSE,fig.cap="\\label{tab:desctab}Descriptive Statistics"}

library(knitr)
library(kableExtra)
library(webshot)


#Late
late_table <- joined %>%
  mutate(Late_Payment = case_when(
    DPD90_KEYCD == 1 ~ "Late",
    DPD90_KEYCD == 0 ~ "Not Late"
  )) %>%
  group_by(Variable = Late_Payment) %>%
  summarize(N=n(),
            `Average FICO` = mean(FICOCLV8_SCORE, na.rm=T),
            `Late Payment %` = NA) %>%
  mutate(Frequency = paste0(round(N/sum(N)*100, 1),"%")) %>%
  relocate(Frequency, .after = N) 

#Race
race_table <- joined %>%
  group_by(Variable = Race) %>%
  filter(!is.na(Race)) %>%
  summarize(N=n(),
            `Average FICO` = mean(FICOCLV8_SCORE, na.rm=T),
            `Late Payment %` = mean(DPD90_KEYCD, na.rm=T)) %>%
  mutate(Frequency = paste0(round(N/sum(N)*100, 1),"%")) %>%
  relocate(Frequency, .after = N) 

#Homeowner
hs_table <- joined %>%
  group_by(Variable=HomeOwnership) %>%
  filter(!is.na(HomeOwnership)) %>%
  summarize(N=n(),
            `Average FICO` = mean(FICOCLV8_SCORE, na.rm=T),
            `Late Payment %` = mean(DPD90_KEYCD, na.rm=T)) %>%
  mutate(Frequency = paste0(round(N/sum(N)*100, 1),"%")) %>%
  relocate(Frequency, .after = N)

#Income
income_table <- joined %>%
  group_by(Variable=Income) %>%
  filter(!is.na(Income)) %>%
  summarize(N=n(),
            `Average FICO` = mean(FICOCLV8_SCORE, na.rm=T),
            `Late Payment %` = mean(DPD90_KEYCD, na.rm=T)) %>%
  mutate(Frequency = paste0(round(N/sum(N)*100, 1),"%")) %>%
  relocate(Frequency, .after = N) 

# Education
edu_table <- joined %>%
  group_by(Variable=Education) %>%
  filter(!is.na(Education)) %>%
  summarize(N=n(),
            `Average FICO` = mean(FICOCLV8_SCORE, na.rm=T),
            `Late Payment %` = mean(DPD90_KEYCD, na.rm=T)) %>%
  mutate(Frequency = paste0(round(N/sum(N)*100, 1),"%")) %>%
  relocate(Frequency, .after = N)

temp <- rbind(late_table, race_table)
temp <- rbind(temp, hs_table)
temp <- rbind(temp, income_table)
temp <- rbind(temp, edu_table)







table1 <- kable( temp,
  digits = 3, format.args = list(big.mark = ",",scientific = FALSE),
 # list(race_table, hs_table),
  caption = 'Descriptive Statistics') %>%
    kable_paper("striped", full_width =T) %>%
#  booktabs = TRUE, valign = 't') 
  pack_rows("Late Payment", 1, 2) %>%
  pack_rows("Race", 3, 6) %>%
  pack_rows("Home Ownershp", 7,8) %>%
  pack_rows("Income", 9,11) %>%
  pack_rows("Education", 12,15)


########################################################

# Save the table as an HTML file
html_file <- "whitepaper/figures/table1.html"
save_kable(table1, file = html_file)

# Save the table as a PDF file
pdf_file <- "whitepaper/figures/table1.pdf"
webshot(html_file, pdf_file)

```







## Bias Measurements



### Profit Maximization






```{r echo=FALSE, message=TRUE, warning=FALSE}
### FICO
pm_threshold = 0.823216
fico_range <- seq(350,850,50)

race_data <- joined %>%
  filter(!is.na(Race))

ndr_df <- data.frame(FICO = fico_range)


for (i in 1:length(ndr_df$FICO))
{
    temp_fico = ndr_df$FICO[i]

    ndr_df$Total[i] <- prop.table(table(race_data$DPD90_KEYCD[(race_data$FICOCLV8_SCORE>temp_fico)]))[1]
    ndr_df$White[i] <- prop.table(table(race_data$DPD90_KEYCD[(race_data$FICOCLV8_SCORE>temp_fico) & (race_data$Race=="White")]))[1]
    ndr_df$Black[i] <- prop.table(table(race_data$DPD90_KEYCD[(race_data$FICOCLV8_SCORE>temp_fico) & (race_data$Race=="Black")]))[1]
    ndr_df$Hispanic[i] <- prop.table(table(race_data$DPD90_KEYCD[(race_data$FICOCLV8_SCORE>temp_fico) & (race_data$Race=="Hispanic")]))[1]
    ndr_df$Asian[i] <- prop.table(table(race_data$DPD90_KEYCD[(race_data$FICOCLV8_SCORE>temp_fico) & (race_data$Race=="Asian")]))[1]

   

}


temp_pm <- reshape2::melt(ndr_df, id.var='FICO')


profit_max_fico <- ggplot(temp_pm, aes(x=FICO, y=value, color=variable))+geom_line() +theme_classic()+
  geom_hline(yintercept=pm_threshold, linetype='dotted',col='black')+
  xlab('FICO Score') + ylab('Non-Default Rate') + labs(color='') + ggtitle("Profit Maximization Threshold Visualization")
```








#### EnergyScore


```{r echo=FALSE, message=FALSE, warning=FALSE}

#EnergyScore

es_range <- seq(0,100,5)

ndr_df_es <- data.frame(ES = es_range)


for (i in 1:length(ndr_df_es$ES))
{

    ndr_df_es$Total[i] <- prop.table(table(race_data$DPD90_KEYCD[(race_data$EnergyScore >= ndr_df_es$ES[i])]))[1]
    ndr_df_es$White[i] <- prop.table(table(race_data$DPD90_KEYCD[(race_data$EnergyScore>=ndr_df_es$ES[i]) & (race_data$Race=="White")]))[1]
    ndr_df_es$Black[i] <- prop.table(table(race_data$DPD90_KEYCD[(race_data$EnergyScore>=ndr_df_es$ES[i]) & (race_data$Race=="Black")]))[1]
    ndr_df_es$Hispanic[i] <- prop.table(table(race_data$DPD90_KEYCD[(race_data$EnergyScore>=ndr_df_es$ES[i]) & (race_data$Race=="Hispanic")]))[1]
    ndr_df_es$Asian[i] <- prop.table(table(race_data$DPD90_KEYCD[(race_data$EnergyScore>=ndr_df_es$ES[i]) & (race_data$Race=="Asian")]))[1]

   

}


temp_pm <- reshape2::melt(ndr_df_es, id.var='ES')


profit_max_es <- ggplot(temp_pm, aes(x=ES, y=value, color=variable))+geom_line() +theme_classic()+
  geom_hline(yintercept=pm_threshold, linetype='dotted',col='black')+
  xlab('EnergyScore') + ylab('Non-Default Rate') + labs(color='') 
#+ ggtitle("Profit Maximization Threshold: EnergyScore")
```


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}



p <- ggplot(data=es_df, aes(x=Variables, y=Thresholds))+geom_bar(stat='identity') + theme_classic() + ggtitle("Profit Maximization EnergyScores")+ ylab("EnergyScore")

ggplotly(p)
```



##### Figure 1

```{r profitmax, echo=FALSE, fig.width=5,fig.height=4,fig.cap="\\label{fig:profitmax}Profit Maximization Threshold"}


grid.arrange(profit_max_fico, profit_max_es, nrow=2)

combined_plot <- grid.arrange(profit_max_fico, profit_max_es, nrow = 2)


# save this png
ggsave("whitepaper/figures/fig1.png",plot = combined_plot, width = 10, height = 10, units = "cm")


```
 


 



##### Figure 2

 
```{r demparity, echo=FALSE, fig.width=5,fig.height=4,fig.cap="\\label{fig:demparity}Demographic Parity Threshold"}


# Total
temp <- joined %>%
  ## add bins
  mutate(FICO_Bin = cut(FICOCLV8_SCORE, breaks=seq(400, 850, 50))) %>%
  filter(axciom9528 !=0) %>%
  filter(!is.na(FICO_Bin)) %>%
  filter(FICOCLV8_SCORE > 0) %>%
  mutate( 
    dummy = 1,
    Race = case_when(
    axciom9528 == "A"| axciom9528=="C" ~ "Asian",
    axciom9528 == "B" ~ "Black",
    axciom9528 == "H" ~ "Hispanic",
    axciom9528 == "W" ~ "White"
  ))  %>%
  filter(!is.na(Race)) %>%
  group_by(FICO_Bin) %>%
  summarize(total = n(),
            total_asian = sum(Race=="Asian", na.rm=T),
            total_white = sum(Race=="White", na.rm=T),
            total_black = sum(Race=="Black", na.rm=T),
            total_hispanic = sum(Race=="Hispanic", na.rm=T)) %>%
  mutate(new_bins = seq(450,850,50) ,
         total_cdf = cumsum(total/sum(total)),
         total_cdf_asian = cumsum(total_asian/sum(total_asian)),
         total_cdf_white = cumsum(total_white/sum(total_white)),
         total_cdf_black = cumsum(total_black/sum(total_black)),
         total_cdf_hispanic = cumsum(total_hispanic/sum(total_hispanic))) %>%
  select(new_bins, Total = total_cdf, Asian = total_cdf_asian, White = total_cdf_white, Black = total_cdf_black, Hispanic = total_cdf_hispanic)




temp <- reshape2::melt(temp, id.var='new_bins')
  
ggplot(temp, aes(x=new_bins, y=value, color=variable))+geom_line() +theme_classic()+
  xlab('FICO Score') + ylab('Fraction of group below') + labs(color='') + ggtitle("Cumulative Distribution Function")   +geom_vline(xintercept=700, linetype='dotted', col = 'black') +
  geom_hline(yintercept=temp$value[temp$new_bins==700 & temp$variable=="Total"], linetype='dotted',col='black')



temp 

temp <- ggplot(temp, aes(x=new_bins, y=value, color=variable))+geom_line() +theme_classic()+
  xlab('FICO Score') + ylab('Fraction of group below') + labs(color='') + ggtitle("Cumulative Distribution Function")   +geom_vline(xintercept=700, linetype='dotted', col = 'black') +
  geom_hline(yintercept=temp$value[temp$new_bins==700 & temp$variable=="Total"], linetype='dotted',col='black')




# save this png
ggsave("whitepaper/figures/fig2.png",plot = temp)

```


### Equal Opportunity




```{r message=FALSE, warning=FALSE, include=FALSE}
just_positives <- joined %>%
  filter(DPD90_KEYCD==0) %>%
  filter(!is.na(Race))


true_positive <- data.frame(fico = seq(450,850,5))

true_positive$Total <- NA
true_positive$Asian <- NA
true_positive$Black <- NA
true_positive$Hispanic <- NA
true_positive$White <- NA

for ( i in 1:length(true_positive$fico)){
  
  true_positive$Total[i] <- sum(just_positives$FICOCLV8_SCORE > true_positive$fico[i])/nrow(just_positives) *100
  true_positive$Asian[i] <- sum(just_positives$FICOCLV8_SCORE[just_positives$Race=="Asian"] > true_positive$fico[i])/ sum(just_positives$Race=="Asian")*100
  true_positive$Black[i] <- sum(just_positives$FICOCLV8_SCORE[just_positives$Race=="Black"] > true_positive$fico[i])/ sum(just_positives$Race=="Black")*100
  true_positive$Hispanic[i] <- sum(just_positives$FICOCLV8_SCORE[just_positives$Race=="Hispanic"] > true_positive$fico[i])/ sum(just_positives$Race=="Hispanic")*100
  true_positive$White[i] <- sum(just_positives$FICOCLV8_SCORE[just_positives$Race=="White"] > true_positive$fico[i])/ sum(just_positives$Race=="White")*100
  
}


t <- reshape2::melt(true_positive, id.var='fico')
  
tp_plot_fico <- ggplot(t, aes(x=value, y=fico, color=variable))+geom_line() +theme_classic()+
  ylab('FICO Score') + xlab('True Positive Rate') + labs(color='') + ggtitle("True Positive Rate and FICO Score by Race") +    geom_vline(xintercept=70, linetype='dotted', col = 'black') + coord_flip() 



```


```{r message=FALSE, warning=FALSE, include=FALSE}
    es_range <- seq(0,100,1)
    
    tp_df <- data.frame(EnergyScore = es_range)
    

      for (i in 1:length(tp_df$EnergyScore))
        
      {
        
        EnergyScore_i = tp_df$EnergyScore[i]
        
        tp_df$Total[i] <- sum((race_data$EnergyScore > tp_df$EnergyScore[i]) & race_data$DPD90_KEYCD==0 )/sum(race_data$DPD90_KEYCD==0)* 100
        
        tp_df$White[i] <- sum((race_data$EnergyScore > tp_df$EnergyScore[i]) & (race_data$DPD90_KEYCD==0) &
                                (race_data$Race=="White"))/sum(race_data$DPD90_KEYCD==0 & race_data$Race=="White")* 100
        
        tp_df$White[i] <- sum((race_data$EnergyScore > tp_df$EnergyScore[i]) & (race_data$DPD90_KEYCD==0) &
                                (race_data$Race=="White"))/sum(race_data$DPD90_KEYCD==0 & race_data$Race=="White")* 100
        
        tp_df$Black[i] <- sum((race_data$EnergyScore > tp_df$EnergyScore[i]) & (race_data$DPD90_KEYCD==0) &
                                (race_data$Race=="Black"))/sum(race_data$DPD90_KEYCD==0 & race_data$Race=="Black")* 100
        
        tp_df$Asian[i] <- sum((race_data$EnergyScore > tp_df$EnergyScore[i]) & (race_data$DPD90_KEYCD==0) &
                                (race_data$Race=="Asian"))/sum(race_data$DPD90_KEYCD==0 & race_data$Race=="Asian")* 100
        
        tp_df$Hispanic[i] <- sum((race_data$EnergyScore > tp_df$EnergyScore[i]) & (race_data$DPD90_KEYCD==0) &
                                   (race_data$Race=="Hispanic"))/sum(race_data$DPD90_KEYCD==0 & race_data$Race=="Hispanic")* 100
      }
      
      
  t <- reshape2::melt(tp_df, id.var='EnergyScore')
  
tp_plot_es <- ggplot(t, aes(x=value, y=EnergyScore, color=variable))+geom_line() +theme_classic()+
  ylab('EnergyScore') + xlab('True Positive Rate') + labs(color='') + ggtitle("True Positive Rate and EnergyScore by Race") +    geom_vline(xintercept=70, linetype='dotted', col = 'black') + coord_flip() 

```

<style>
#### Figure 3
{
   display: none;
 }
</style> 
 
```{r equalop, echo=FALSE, fig.width=5,fig.height=4,fig.cap="\\label{fig:equalop}Equal Opportunity Threshold"}
grid.arrange(tp_plot_fico, tp_plot_es, nrow=2)

combined_plot <- grid.arrange(tp_plot_fico, tp_plot_es, nrow = 2)


# save this png
ggsave("whitepaper/figures/fig3.png",plot = combined_plot)


```




### Intra- and Inter-Group 







## Thresholds




### Race








```{r message=FALSE, warning=FALSE, include=FALSE}
# EnergyScore 

es_df <- profit_max_thresh("EnergyScore", "Race", 0.823)

es_df <- es_df %>%
  rename("Profit Max" = "Thresholds" ,
         "Race" = "Variables") %>%
  mutate("Race Blind" = 1) %>%
  mutate("Demographic Parity" = NA,
         "Equal Opportunity" = NA) %>%
  filter(Race !="Total")

temp_thresh = 0.7

es_df$`Demographic Parity` = c(demo_parity_thresh("Race", "White", temp_thresh)[[1]][2],
            demo_parity_thresh("Race", "Asian", temp_thresh)[[1]][2],
            demo_parity_thresh("Race", "Black", temp_thresh)[[1]][2],
            demo_parity_thresh("Race", "Hispanic", temp_thresh)[[1]][2])

temp <- equ_op_thresh("EnergyScore","Race", 90)


es_df$`Equal Opportunity`[es_df$Race=="White"] <- temp$Thresholds[temp$Variables=="White"]
es_df$`Equal Opportunity`[es_df$Race=="Black"] <- temp$Thresholds[temp$Variables=="Black"]
es_df$`Equal Opportunity`[es_df$Race=="Hispanic"] <- temp$Thresholds[temp$Variables=="Hispanic"]
es_df$`Equal Opportunity`[es_df$Race=="Asian"] <- temp$Thresholds[temp$Variables=="Asian"]

bar_data_race_es <- reshape2::melt(es_df, id.var='Race') 

bar_data_race_es$Population <- NA
bar_data_race_es$Percentage <- NA

for (i in 1:length(bar_data_race_es$Race))
  
{
  
  bar_data_race_es$Population[i] <- sum(joined$dummy[joined$Race==bar_data_race_es$Race[i] & 
                                                  joined$EnergyScore >= bar_data_race_es$value[i]], na.rm=T)
  
  bar_data_race_es$Percentage[i] <- bar_data_race_es$Population[i]/sum(joined$dummy[joined$Race==bar_data_race_es$Race[i]],
                                                                 na.rm=T)
  
  bar_data_race_es$TP_Percentage[i] <- sum(joined$dummy[joined$Race==bar_data_race_es$Race[i] &
                                                          joined$EnergyScore >= bar_data_race_es$value[i] &
                                                          joined$DPD90_KEYCD==0], na.rm=T)/bar_data_race_es$Population[i]
  
}

# FICO 

fico_df <- profit_max_thresh("FICO", "Race", 0.823)

fico_df <- fico_df %>%
  rename("Profit Max" = "Thresholds",
         "Race" = "Variables") %>%
  mutate("Race Blind" = 620) %>%
  mutate("Demographic Parity" = NA,
         "Equal Opportunity" = NA) %>%
  filter(Race !="Total")

temp_thresh = 0.7

fico_df$`Demographic Parity` = c(demo_parity_thresh("Race", "White", temp_thresh)[[1]][1],
            demo_parity_thresh("Race", "Asian", temp_thresh)[[1]][1],
            demo_parity_thresh("Race", "Black", temp_thresh)[[1]][1],
            demo_parity_thresh("Race", "Hispanic", temp_thresh)[[1]][1])

temp <- equ_op_thresh("FICO","Race", 90)


fico_df$`Equal Opportunity`[fico_df$Race=="White"] <- temp$Thresholds[temp$Variables=="White"]
fico_df$`Equal Opportunity`[fico_df$Race=="Black"] <- temp$Thresholds[temp$Variables=="Black"]
fico_df$`Equal Opportunity`[fico_df$Race=="Hispanic"] <- temp$Thresholds[temp$Variables=="Hispanic"]
fico_df$`Equal Opportunity`[fico_df$Race=="Asian"] <- temp$Thresholds[temp$Variables=="Asian"]



bar_data_race_fico <- reshape2::melt(fico_df, id.var='Race')

bar_data_race_fico$Population <- NA
bar_data_race_fico$Percentage <- NA

for (i in 1:length(bar_data_race_fico$Race))
  
{
  
  bar_data_race_fico$Population[i] <- sum(joined$dummy[joined$Race==bar_data_race_fico$Race[i] & 
                                                  joined$FICOCLV8_SCORE >= bar_data_race_fico$value[i]], na.rm=T)
  
  bar_data_race_fico$Percentage[i] <- bar_data_race_fico$Population[i]/sum(joined$dummy[joined$Race==bar_data_race_fico$Race[i]],
                                                                 na.rm=T)
  
  bar_data_race_fico$TP_Percentage[i] <- sum(joined$dummy[joined$Race==bar_data_race_fico$Race[i] &
                                                          joined$FICOCLV8_SCORE >= bar_data_race_fico$value[i] &
                                                          joined$DPD90_KEYCD==0], na.rm=T)/bar_data_race_fico$Population[i]
}
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

temp <- reshape2::melt(fico_df, id.var='Race')


tempa <- ggplot(temp, aes(value, variable, color=Race)) +
  geom_point(alpha=0.5, size=5) + theme_classic() +
  scale_colour_discrete("Race") + xlab("FICO") + ylab("")+ 
  scale_x_continuous(limits=c(400, 800)) + 
  labs(color="Cluster") +
  theme(axis.text = element_text(size=10),         axis.text.y = element_text(size=10))
  #+
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))

temp <- reshape2::melt(es_df, id.var='Race')


tempb <- ggplot(temp, aes(value, variable, color=Race)) +
  geom_point(alpha=0.5, size=5) + theme_classic() +
  scale_colour_discrete("Race") + xlab("EnergyScore") + ylab("")+ 
 # scale_x_continuous(limits=c(400, 800)) + 
  labs(color="Cluster")  +
  theme(axis.text = element_text(size=10),         axis.text.y = element_text(size=10))#+
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))


```













### Income







```{r message=FALSE, warning=FALSE, include=FALSE}
# EnergyScore 

es_df <- profit_max_thresh("EnergyScore", "Income", 0.823)

es_df <- es_df %>%
  rename("Profit Max" = "Thresholds" ,
         "Income" = "Variables") %>%
  mutate("Race Blind" = 1) %>%
  mutate("Demographic Parity" = NA,
         "Equal Opportunity" = NA) %>%
  filter(Income !="Total")

temp_thresh = 0.7

es_df$`Demographic Parity` = c(demo_parity_thresh("Income", "Low", temp_thresh)[[1]][2],
            demo_parity_thresh("Income", "Medium", temp_thresh)[[1]][2],
            demo_parity_thresh("Income", "High", temp_thresh)[[1]][2])

temp <- equ_op_thresh("EnergyScore","Income", 90)


es_df$`Equal Opportunity`[es_df$Income=="Low"] <- temp$Thresholds[temp$Variables=="High"]
es_df$`Equal Opportunity`[es_df$Income=="Medium"] <- temp$Thresholds[temp$Variables=="Medium"]
es_df$`Equal Opportunity`[es_df$Income=="High"] <- temp$Thresholds[temp$Variables=="High"]

bar_data_income_es <- reshape2::melt(es_df, id.var='Income') 

bar_data_income_es$Population <- NA
bar_data_income_es$Percentage <- NA

for (i in 1:length(bar_data_income_es$Income))
  
{
  
  bar_data_income_es$Population[i] <- sum(joined$dummy[joined$Income==bar_data_income_es$Income[i] & 
                                                  joined$EnergyScore >= bar_data_income_es$value[i]], na.rm=T)
  
  bar_data_income_es$Percentage[i] <- bar_data_income_es$Population[i]/sum(joined$dummy[joined$Income==bar_data_income_es$Income[i]],
                                                                 na.rm=T)
  
  bar_data_income_es$TP_Percentage[i] <- sum(joined$dummy[joined$Income==bar_data_income_es$Income[i] &
                                                          joined$EnergyScore >= bar_data_income_es$value[i] &
                                                          joined$DPD90_KEYCD==0], na.rm=T)/bar_data_income_es$Population[i]
  
}



# FICO 

fico_df <- profit_max_thresh("FICO", "Income", 0.823)

fico_df <- fico_df %>%
  rename("Profit Max" = "Thresholds",
         "Income" = "Variables") %>%
  mutate("Race Blind" = 620) %>%
  mutate("Demographic Parity" = NA,
         "Equal Opportunity" = NA) %>%
  filter(Income !="Total")

temp_thresh = 0.7

fico_df$`Demographic Parity` = c(demo_parity_thresh("Income", "Low", temp_thresh)[[1]][1],
            demo_parity_thresh("Income", "Medium", temp_thresh)[[1]][1],
            demo_parity_thresh("Income", "High", temp_thresh)[[1]][1])

temp <- equ_op_thresh("FICO","Income", 90)


fico_df$`Equal Opportunity`[fico_df$Income=="Low"] <- temp$Thresholds[temp$Variables=="Low"]
fico_df$`Equal Opportunity`[fico_df$Income=="Medium"] <- temp$Thresholds[temp$Variables=="Medium"]
fico_df$`Equal Opportunity`[fico_df$Income=="High"] <- temp$Thresholds[temp$Variables=="High"]

bar_data_income_fico <- reshape2::melt(fico_df, id.var='Income')

bar_data_income_fico$Population <- NA
bar_data_income_fico$Percentage <- NA

for (i in 1:length(bar_data_income_fico$Income))
  
{
  
  bar_data_income_fico$Population[i] <- sum(joined$dummy[joined$Income==bar_data_income_fico$Income[i] & 
                                                  joined$FICOCLV8_SCORE >= bar_data_income_fico$value[i]], na.rm=T)
  
  bar_data_income_fico$Percentage[i] <- bar_data_income_fico$Population[i]/sum(joined$dummy[joined$Income==bar_data_income_fico$Income[i]],
                                                                 na.rm=T)
  
  bar_data_income_fico$TP_Percentage[i] <- sum(joined$dummy[joined$Income==bar_data_income_fico$Income[i] &
                                                          joined$FICOCLV8_SCORE >= bar_data_income_fico$value[i] &
                                                          joined$DPD90_KEYCD==0], na.rm=T)/bar_data_income_fico$Population[i]
}



```


```{r message=FALSE, warning=FALSE, include=FALSE}

temp <- reshape2::melt(fico_df, id.var='Income')


tempc <- ggplot(temp, aes(value, variable, color=Income)) +
  geom_point(alpha=0.5, size=5) + theme_classic() +
  scale_colour_discrete("Income") + xlab("FICO") + ylab("")+ 
  scale_x_continuous(limits=c(400, 800)) + 
  theme(axis.text = element_text(size=10),         axis.text.y = element_text(size=10)) +
  labs(color="Cluster")# +
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))

tempc
```



```{r message=FALSE, warning=FALSE, include=FALSE}

temp <- reshape2::melt(es_df, id.var='Income')



tempd <- ggplot(temp, aes(value, variable, color=Income)) +
  geom_point(alpha=0.5, size=5) + theme_classic() +
  scale_colour_discrete("Income") + xlab("EnergyScore") + ylab("")+ scale_x_continuous(limits=c(0, 100)) +
  theme(axis.text = element_text(size=10),         axis.text.y = element_text(size=10))+ labs(color="Cluster") 
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))


```




#### Figure 4



```{r fpfig1, echo=FALSE, fig.width=10,fig.height=6,fig.cap="\\label{fig:fpfig1}Cutoff Comparisons"}


grid.arrange(tempa, tempb, tempc, tempd, nrow=2, ncol=2)

combined_plot <- grid.arrange(tempa, tempb, tempc, tempd, nrow = 2, ncol = 2)

ggsave("whitepaper/figures/fig4.png",plot = combined_plot)


```







### Education




```{r message=FALSE, warning=FALSE, include=FALSE}
# EnergyScore 

es_df <- profit_max_thresh("EnergyScore", "Education", 0.823)

es_df <- es_df %>%
  rename("Profit Max" = "Thresholds" ,
         "Education" = "Variables") %>%
  mutate("Race Blind" = 1) %>%
  mutate("Demographic Parity" = NA,
         "Equal Opportunity" = NA) %>%
  filter(Education !="Total")

temp_thresh = 0.7

es_df$`Demographic Parity` = c(demo_parity_thresh("Education", "Vocational/Technical", temp_thresh)[[1]][2],
            demo_parity_thresh("Education", "High School", temp_thresh)[[1]][2],
            demo_parity_thresh("Education", "College", temp_thresh)[[1]][2],
            demo_parity_thresh("Education", "Graduate School", temp_thresh)[[1]][2])

temp <- equ_op_thresh("EnergyScore","Education", 90)


es_df$`Equal Opportunity`[es_df$Education=="Vocational/Technical"] <- temp$Thresholds[temp$Variables=="Vocational/Technical"]
es_df$`Equal Opportunity`[es_df$Education=="High School"] <- temp$Thresholds[temp$Variables=="High School"]
es_df$`Equal Opportunity`[es_df$Education=="College"] <- temp$Thresholds[temp$Variables=="College"]
es_df$`Equal Opportunity`[es_df$Education=="Graduate School"] <- temp$Thresholds[temp$Variables=="Graduate School"]


bar_data_edu_es <- reshape2::melt(es_df, id.var='Education') 

bar_data_edu_es$Population <- NA
bar_data_edu_es$Percentage <- NA

for (i in 1:length(bar_data_edu_es$Education))
  
{
  
  bar_data_edu_es$Population[i] <- sum(joined$dummy[joined$Education==bar_data_edu_es$Education[i] & 
                                                  joined$EnergyScore >= bar_data_edu_es$value[i]], na.rm=T)
  
  bar_data_edu_es$Percentage[i] <- bar_data_edu_es$Population[i]/sum(joined$dummy[joined$Education==bar_data_edu_es$Education[i]],
                                                                 na.rm=T)
  
  bar_data_edu_es$TP_Percentage[i] <- sum(joined$dummy[joined$Education==bar_data_edu_es$Education[i] &
                                                          joined$EnergyScore >= bar_data_edu_es$value[i] &
                                                          joined$DPD90_KEYCD==0], na.rm=T)/bar_data_edu_es$Population[i]
  
}




# FICO 

fico_df <- profit_max_thresh("FICO", "Education", 0.823)

fico_df <- fico_df %>%
  rename("Profit Max" = "Thresholds",
         "Education" = "Variables") %>%
  mutate("Race Blind" = 620) %>%
  mutate("Demographic Parity" = NA,
         "Equal Opportunity" = NA) %>%
  filter(Education !="Total")

temp_thresh = 0.7

fico_df$`Demographic Parity` = c(demo_parity_thresh("Education", "Vocational/Technical", temp_thresh)[[1]][1],
            demo_parity_thresh("Education", "High School", temp_thresh)[[1]][1],
            demo_parity_thresh("Education", "College", temp_thresh)[[1]][1],
            demo_parity_thresh("Education", "Graduate School", temp_thresh)[[1]][1])

temp <- equ_op_thresh("FICO","Education", 90)



fico_df$`Equal Opportunity`[fico_df$Education=="Vocational/Technical"] <- temp$Thresholds[temp$Variables=="Vocational/Technical"]
fico_df$`Equal Opportunity`[fico_df$Education=="High School"] <- temp$Thresholds[temp$Variables=="High School"]
fico_df$`Equal Opportunity`[fico_df$Education=="College"] <- temp$Thresholds[temp$Variables=="College"]
fico_df$`Equal Opportunity`[fico_df$Education=="Graduate School"] <- temp$Thresholds[temp$Variables=="Graduate School"]

bar_data_edu_fico <- reshape2::melt(fico_df, id.var='Education')

bar_data_edu_fico$Population <- NA
bar_data_edu_fico$Percentage <- NA

for (i in 1:length(bar_data_edu_fico$Education))
  
{
  
  bar_data_edu_fico$Population[i] <- sum(joined$dummy[joined$Education==bar_data_edu_fico$Education[i] & 
                                                  joined$FICOCLV8_SCORE >= bar_data_edu_fico$value[i]], na.rm=T)
  
  bar_data_edu_fico$Percentage[i] <- bar_data_edu_fico$Population[i]/sum(joined$dummy[joined$Education==bar_data_edu_fico$Education[i]],
                                                                 na.rm=T)
  
  bar_data_edu_fico$TP_Percentage[i] <- sum(joined$dummy[joined$Education==bar_data_edu_fico$Education[i] &
                                                          joined$FICOCLV8_SCORE >= bar_data_edu_fico$value[i] &
                                                          joined$DPD90_KEYCD==0], na.rm=T)/bar_data_edu_fico$Population[i]
}


```


```{r message=FALSE, warning=FALSE, include=FALSE}

temp <- reshape2::melt(fico_df, id.var='Education')


tempe <- ggplot(temp, aes(value, variable, color=Education)) +
  geom_point(alpha=0.5, size=5) + theme_classic() +
  scale_colour_discrete("Education") + xlab("FICO") + ylab("")+ 
  scale_x_continuous(limits=c(400, 800)) +
  theme(axis.text = element_text(size=10),         axis.text.y = element_text(size=10)) +
  #scale_x_continuous(limits=c(0, 100)) + 
  labs(color="Cluster") #+
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))

tempe
```



```{r message=FALSE, warning=FALSE, include=FALSE}

temp <- reshape2::melt(es_df, id.var='Education')



tempf <- ggplot(temp, aes(value, variable, color=Education)) +
  geom_point(alpha=0.5, size=5) + theme_classic() + 
  theme(axis.text = element_text(size=10),         axis.text.y = element_text(size=10)) +
  scale_colour_discrete("Education") + xlab("EnergyScore") + ylab("")+ scale_x_continuous(limits=c(0, 100)) + labs(color="Cluster") #+
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))
tempf
```








### Homeownership





```{r message=FALSE, warning=FALSE, include=FALSE}
# EnergyScore 

es_df <- profit_max_thresh("EnergyScore", "HomeOwnership", 0.823)

es_df <- es_df %>%
  rename("Profit Max" = "Thresholds" ,
         "HomeOwnership" = "Variables") %>%
  mutate("Race Blind" = 1) %>%
  mutate("Demographic Parity" = NA,
         "Equal Opportunity" = NA) %>%
  filter(HomeOwnership !="Total")

temp_thresh = 0.7

es_df$`Demographic Parity` = c(demo_parity_thresh("HomeOwnership", "Rent", temp_thresh)[[1]][2],
            demo_parity_thresh("HomeOwnership", "Own", temp_thresh)[[1]][2])

temp <- equ_op_thresh("EnergyScore","HomeOwnership", 90)


es_df$`Equal Opportunity`[es_df$HomeOwnership=="Rent"] <- temp$Thresholds[temp$Variables=="Rent"]
es_df$`Equal Opportunity`[es_df$HomeOwnership=="Own"] <- temp$Thresholds[temp$Variables=="Own"]


bar_data_hs_es <- reshape2::melt(es_df, id.var='HomeOwnership') 

bar_data_hs_es$Population <- NA
bar_data_hs_es$Percentage <- NA

for (i in 1:length(bar_data_hs_es$HomeOwnership))
  
{
  
  bar_data_hs_es$Population[i] <- sum(joined$dummy[joined$HomeOwnership==bar_data_hs_es$HomeOwnership[i] & 
                                                  joined$EnergyScore >= bar_data_hs_es$value[i]], na.rm=T)
  
  bar_data_hs_es$Percentage[i] <- bar_data_hs_es$Population[i]/sum(joined$dummy[joined$HomeOwnership==bar_data_hs_es$HomeOwnership[i]],
                                                                 na.rm=T)
  
  bar_data_hs_es$TP_Percentage[i] <- sum(joined$dummy[joined$HomeOwnership==bar_data_hs_es$HomeOwnership[i] &
                                                          joined$EnergyScore >= bar_data_hs_es$value[i] &
                                                          joined$DPD90_KEYCD==0], na.rm=T)/bar_data_hs_es$Population[i]
  
}


# FICO 

fico_df <- profit_max_thresh("FICO", "HomeOwnership", 0.823)

fico_df <- fico_df %>%
  rename("Profit Max" = "Thresholds",
         "HomeOwnership" = "Variables") %>%
  mutate("Race Blind" = 620) %>%
  mutate("Demographic Parity" = NA,
         "Equal Opportunity" = NA) %>%
  filter(HomeOwnership !="Total")

temp_thresh = 0.7

fico_df$`Demographic Parity` = c(demo_parity_thresh("HomeOwnership", "Low", temp_thresh)[[1]][1],
            demo_parity_thresh("HomeOwnership", "High", temp_thresh)[[1]][1])

temp <- equ_op_thresh("FICO","HomeOwnership", 90)


fico_df$`Equal Opportunity`[fico_df$HomeOwnership=="Rent"] <- temp$Thresholds[temp$Variables=="Rent"]
fico_df$`Equal Opportunity`[fico_df$HomeOwnership=="Own"] <- temp$Thresholds[temp$Variables=="Own"]



bar_data_hs_fico <- reshape2::melt(fico_df, id.var='HomeOwnership')

bar_data_hs_fico$Population <- NA
bar_data_hs_fico$Percentage <- NA

for (i in 1:length(bar_data_hs_fico$HomeOwnership))
  
{
  
  bar_data_hs_fico$Population[i] <- sum(joined$dummy[joined$HomeOwnership==bar_data_hs_fico$HomeOwnership[i] & 
                                                  joined$FICOCLV8_SCORE >= bar_data_hs_fico$value[i]], na.rm=T)
  
  bar_data_hs_fico$Percentage[i] <- bar_data_hs_fico$Population[i]/sum(joined$dummy[joined$HomeOwnership==bar_data_hs_fico$HomeOwnership[i]],
                                                                 na.rm=T)
  
  bar_data_hs_fico$TP_Percentage[i] <- sum(joined$dummy[joined$HomeOwnership==bar_data_hs_fico$HomeOwnership[i] &
                                                          joined$FICOCLV8_SCORE >= bar_data_hs_fico$value[i] &
                                                          joined$DPD90_KEYCD==0], na.rm=T)/bar_data_hs_fico$Population[i]
}




```


```{r message=FALSE, warning=FALSE, include=FALSE}

temp <- reshape2::melt(fico_df, id.var='HomeOwnership')


tempg <- ggplot(temp, aes(value, variable, color=HomeOwnership)) +
  geom_point(alpha=0.5, size=5) + theme_classic() +
  scale_x_continuous(limits=c(400, 800)) + 
  theme(axis.text = element_text(size=10),         axis.text.y = element_text(size=10)) +
  scale_colour_discrete("HomeOwnership") + xlab("FICO") + ylab("")+ 
  #scale_x_continuous(limits=c(0, 100)) + 
  labs(color="Cluster") #+
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))

tempg
```



```{r message=FALSE, warning=FALSE, include=FALSE}

temp <- reshape2::melt(es_df, id.var='HomeOwnership')


temph <- ggplot(temp, aes(value, variable, color=HomeOwnership)) +
  geom_point(alpha=0.5, size=5) + theme_classic() + 
  theme(axis.text = element_text(size=10),         axis.text.y = element_text(size=10)) +
  scale_colour_discrete("HomeOwnership") + xlab("EnergyScore") + ylab("")+ scale_x_continuous(limits=c(0, 100)) + labs(color="Cluster") #+
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))

temph
```




#### Figure 5


```{r fpfig2, echo=FALSE, fig.width=11,fig.height=6,fig.cap="\\label{fig:fpfig2}Cutoff Comparison Continued"}


grid.arrange(tempe, tempf, tempg, temph, nrow=2, ncol=2)

combined_plot <- grid.arrange(tempe, tempf, tempg, temph, nrow = 2, ncol = 2)

ggsave("whitepaper/figures/fig5.png",plot = combined_plot, width = 10, height = 10, units = "cm")



```




## Intra Group Percentiles





### Race

```{r message=FALSE, warning=FALSE, include=FALSE}

inter_var <- function(df) {
  result <- df %>%
    mutate(temp = .[[1]]) %>%
    group_by(temp) %>%
    summarize(
      Variance_FICO = var(Percentile_FICO, na.rm=T),
      Variance_ES = var(Percentile_ES, na.rm=T)
    )
  return(result)
}

intra_var <- function(df) {
  
  result <- df %>%
    group_by(df[2]) %>%
    summarize(
      Variance_FICO = var(Percentile_FICO, na.rm=T),
      Variance_ES = var(Percentile_ES, na.rm=T)
    )
  return(result)
  
}



```





```{r message=FALSE, warning=FALSE, include=FALSE}

temp_fico <- bar_data_race_fico %>%
  dplyr::select(Race, variable, Percentile_FICO=Percentage) 

temp_es <- bar_data_race_es %>%
  dplyr::select(Race, variable,Percentile_ES= Percentage)

temp_combined <- cbind(temp_es,temp_fico)
temp_combined <- temp_combined [-1]

temp_combined <- temp_combined %>%
  dplyr::select(Race, variable, Percentile_FICO, Percentile_ES)

p1 <- ggplot(data=temp_combined, aes(x=Percentile_FICO, y=variable, fill=Race))+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=2)+ 
  theme_minimal() + 
  theme(axis.text = element_text(size=15), 
        axis.text.y = element_text(size=15),
        legend.text = element_text(size=15)) +
    
  ggtitle("FICO")+ ylab("") + xlab("") + xlim(0,1) #+
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))
p1

p2 <- ggplot(data=temp_combined, aes(x=Percentile_ES, y=variable, fill=Race))+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=2)+ 
    theme_minimal() + 
  theme(axis.text = element_text(size=15), 
        axis.text.y = element_text(size=15),
        legend.text = element_text(size=15)) +    ggtitle("EnergyScore")+ ylab("") + xlab("")+ xlim(0,1) #+
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))
p2




```



```{r message=FALSE, warning=FALSE, include=FALSE}

race_intra <- intra_var(temp_combined)

race_inter <- inter_var(temp_combined)


```



### Income





```{r message=FALSE, warning=FALSE, include=FALSE}

temp_fico <- bar_data_income_fico %>%
  dplyr::select(Income, variable, Percentile_FICO=Percentage) 

temp_es <- bar_data_income_es %>%
  dplyr::select(Income, variable,Percentile_ES= Percentage)

temp_combined <- cbind(temp_es,temp_fico)
temp_combined <- temp_combined [-1]

temp_combined <- temp_combined %>%
  dplyr::select(Income, variable, Percentile_FICO, Percentile_ES)

p3 <- ggplot(data=temp_combined, aes(x=Percentile_FICO, y=variable, fill=Income))+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=2)+ theme_minimal() + 
  theme(axis.text = element_text(size=15), 
        axis.text.y = element_text(size=15),
        legend.text = element_text(size=15)) +
  ggtitle("FICO")+ ylab("") + xlab("") + xlim(0,1)#+
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))
p3

p4 <- ggplot(data=temp_combined, aes(x=Percentile_ES, y=variable, fill=Income))+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=2)+ 
  theme_minimal() + 
  theme(axis.text = element_text(size=15), 
        axis.text.y = element_text(size=15),
        legend.text = element_text(size=15)) +
  ggtitle("EnergyScore")+ ylab("") + xlab("")+ xlim(0,1) #+
    # theme(axis.text.x=element_text(size=20),
    #     axis.text.y=element_text(size=20),
    #     plot.title = element_text(size=20),
    #     legend.title = element_text(size=20),
    #     legend.text = element_text(size=20))
p4




```


```{r message=FALSE, warning=FALSE, include=FALSE}

income_intra <- intra_var(temp_combined)
income_inter <- inter_var(temp_combined)


```



#### Figure 6


```{r intra, echo=FALSE, fig.width=12,fig.height=8,fig.cap="\\label{fig:intra}Intra-Group Percentiles Comparison"}


grid.arrange(p1, p2, p3, p4, nrow=2, ncol=2)

combined_plot <- grid.arrange(p1, p2, p3, p4, nrow=2, ncol=2)

ggsave("whitepaper/figures/fig6.png",plot = combined_plot)


```





### Education





```{r message=FALSE, warning=FALSE, include=FALSE}

temp_fico <- bar_data_edu_fico %>%
  dplyr::select(Education, variable, Percentile_FICO=Percentage) 

temp_es <- bar_data_edu_es %>%
  dplyr::select(Education, variable,Percentile_ES= Percentage)

temp_combined <- cbind(temp_es,temp_fico)
temp_combined <- temp_combined [-1]

temp_combined <- temp_combined %>%
  dplyr::select(Education, variable, Percentile_FICO, Percentile_ES)

p1 <- ggplot(data=temp_combined, aes(x=Percentile_FICO, y=variable, fill=Education))+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=2)+ 
   theme_minimal() +
  theme(axis.text = element_text(size=15), 
        axis.text.y = element_text(size=15),
        legend.text = element_text(size=10)) + ylab("") + xlab("") + xlim(0,1) + ggtitle("FICO")#+
  # theme(axis.text.x=element_text(size=20),
  #       axis.text.y=element_text(size=20),
  #       plot.title = element_text(size=20),
  #       legend.title = element_text(size=20),
  #       legend.text = element_text(size=20))

p1

p2 <- ggplot(data=temp_combined, aes(x=Percentile_ES, y=variable, fill=Education))+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=2)+ 
   theme_minimal() +
  theme(axis.text = element_text(size=15), 
        axis.text.y = element_text(size=15),
        legend.text = element_text(size=10)) +
    ylab("") + xlab("")+ xlim(0,1) + ggtitle("EnergyScore")#+
  # theme(axis.text.x=element_text(size=20),
  #       axis.text.y=element_text(size=20),
  #       plot.title = element_text(size=20),
  #       legend.title = element_text(size=20),
  #       legend.text = element_text(size=20))
p2




```


```{r message=FALSE, warning=FALSE, include=FALSE}

edu_intra <- intra_var(temp_combined)
edu_inter <- inter_var(temp_combined)


```



### Homeownership




```{r message=FALSE, warning=FALSE, include=FALSE}

temp_fico <- bar_data_hs_fico %>%
  dplyr::select(HomeOwnership, variable, Percentile_FICO=Percentage) 

temp_es <- bar_data_hs_es %>%
  dplyr::select(HomeOwnership, variable,Percentile_ES= Percentage)

temp_combined <- cbind(temp_es,temp_fico)
temp_combined <- temp_combined [-1]

temp_combined <- temp_combined %>%
  dplyr::select(HomeOwnership, variable, Percentile_FICO, Percentile_ES)

p3 <- ggplot(data=temp_combined, aes(x=Percentile_FICO, y=variable, fill=HomeOwnership))+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=2)+ 
   theme_minimal() +
  theme(axis.text = element_text(size=15), 
        axis.text.y = element_text(size=15),
        legend.text = element_text(size=15))  + ylab("")  + xlim(0,1)+ xlab("")+ ggtitle("FICO")#+
  # theme(axis.text.x=element_text(size=20),
  #       axis.text.y=element_text(size=20),
  #       plot.title = element_text(size=20),
  #       legend.title = element_text(size=20),
  #       legend.text = element_text(size=20))
p3

p4 <- ggplot(data=temp_combined, aes(x=Percentile_ES, y=variable, fill=HomeOwnership))+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=2)+ 
     theme_minimal() +
  theme(axis.text = element_text(size=15), 
        axis.text.y = element_text(size=15),
        legend.text = element_text(size=15)) + ylab("") +  xlim(0,1) + xlab("")+ ggtitle("EnergyScore")# +
  # theme(axis.text.x=element_text(size=20),
  #       axis.text.y=element_text(size=20),
  #       plot.title = element_text(size=20),
  #       legend.title = element_text(size=20),
  #       legend.text = element_text(size=20))
p4




```


```{r message=FALSE, warning=FALSE, include=FALSE}

hs_intra <- intra_var(temp_combined)
hs_inter <- inter_var(temp_combined)


```




#### Figure 7


```{r intra2, echo=FALSE, fig.width=12,fig.height=8,fig.cap="\\label{fig:intra2}Intra-Group Percentiles Comparison Continued"}


grid.arrange(p1, p2, p3, p4, nrow=2, ncol=2)

combined_plot <- grid.arrange(p1, p2, p3, p4, nrow=2, ncol=2)

ggsave("whitepaper/figures/fig7.png",plot = combined_plot)

```



## Intra- and Inter-group


### Table 2



```{r echo=FALSE, message=FALSE, warning=FALSE}


temp_table <- rbind(edu_inter, hs_inter, income_inter, race_inter) 

temp_table <- temp_table %>%
  select(Variable = temp, FICO = Variance_FICO, EnergyScore = Variance_ES)

table2 <- kable( temp_table,
  digits = 3, format.args = list(big.mark = ",",scientific = FALSE),
 # list(race_table, hs_table),
  caption = 'Inter-Group Variance') %>%
    kable_paper("striped", full_width =T) %>%
#  booktabs = TRUE, valign = 't') 
  pack_rows("Education", 1, 4) %>%
  pack_rows("Home Ownership", 5, 6) %>%
  pack_rows("Income", 7,9) %>%
  pack_rows("Race", 10,13) 

table2

# Save the table as an HTML file
html_file <- "whitepaper/figures/table2.html"
save_kable(table2, file = html_file)

# Save the table as a PDF file
pdf_file <- "whitepaper/figures/table2.pdf"
webshot(html_file, pdf_file)

```



### Table 3



```{r echo=FALSE, message=FALSE, warning=FALSE}


temp_table <- rbind(edu_intra, hs_intra, income_intra, race_intra) 

temp_table <- temp_table %>%
  select(Variable = variable, FICO = Variance_FICO, EnergyScore = Variance_ES)

table3 <- kable( temp_table,
  digits = 3, format.args = list(big.mark = ",",scientific = FALSE),
 # list(race_table, hs_table),
  caption = 'Intra-Group Variance') %>%
    kable_paper("striped", full_width =T) %>%
#  booktabs = TRUE, valign = 't') 
  pack_rows("Education", 1, 4) %>%
  pack_rows("Home Ownership", 5, 8) %>%
  pack_rows("Income", 9,12) %>%
  pack_rows("Race", 13,16) 

table3 

# Save the table as an HTML file
html_file <- "whitepaper/figures/table3.html"
save_kable(table3, file = html_file)

# Save the table as a PDF file
pdf_file <- "whitepaper/figures/table3.pdf"
webshot(html_file, pdf_file)
```












## False Positive Comparisons


### Race and Income





#### Figure 8



```{r echo=FALSE, message=FALSE, warning=FALSE}
new_bins = seq(400,840,10)

false_positives <- joined %>%
  mutate(FICO_Bin = cut(FICOCLV8_SCORE, breaks=seq(400, 850, 10))) %>%
  filter(!is.na(FICO_Bin)) %>%
  filter(FICOCLV8_SCORE > 0) %>%
  group_by(FICO_Bin) %>%
  summarize(n=n())%>%
  mutate(new_bins = new_bins ) %>%
  select(new_bins, n) 
  
false_positives$ES_Cut <- NA
false_positives$FICO_FP <- NA
false_positives$FICO_FP_White <- NA
false_positives$FICO_FP_Black <- NA
false_positives$FICO_FP_Hispanic <- NA
false_positives$FICO_FP_Asian <- NA
false_positives$ES_FP <- NA

false_positives$ES_FP_White <- NA
false_positives$ES_FP_Black <- NA
false_positives$ES_FP_Hispanic <- NA
false_positives$ES_FP_Asian <- NA



for (i in 1:length(false_positives$new_bins))
  
{
  false_positives$ES_Cut[i] <- quantile(joined$Prob_Not_Def,(1-(sum(joined$FICOCLV8_SCORE> false_positives$new_bins[i], na.rm=T)/sum(joined$FICOCLV8_SCORE>0, na.rm=T))))
  
  
  false_positives$FICO_FP[i] <- mean(joined$DPD90_KEYCD[joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  
  false_positives$FICO_FP_White[i] <- mean(joined$DPD90_KEYCD[joined$Race=="White" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  false_positives$FICO_FP_Black[i] <- mean(joined$DPD90_KEYCD[joined$Race=="Black" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  false_positives$FICO_FP_Hispanic[i] <- mean(joined$DPD90_KEYCD[joined$Race=="Hispanic" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  false_positives$FICO_FP_Asian[i] <- mean(joined$DPD90_KEYCD[joined$Race=="Asian" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  


  
}



for (i in 1:length(false_positives$new_bins))
  
{
  
  false_positives$ES_FP[i] <- mean(joined$DPD90_KEYCD[joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  
  false_positives$ES_FP_White[i] <- mean(joined$DPD90_KEYCD[joined$Race=="White" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_Black[i] <- mean(joined$DPD90_KEYCD[joined$Race=="Black" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_Hispanic[i] <- mean(joined$DPD90_KEYCD[joined$Race=="Hispanic" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_Asian[i] <- mean(joined$DPD90_KEYCD[joined$Race=="Asian" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  
}
```





```{r echo=FALSE, message=FALSE, warning=FALSE}
## only select FICO >=600
library(scales)
false_positives <- false_positives %>%
  filter(new_bins>590)

myColors <- c("darkgreen", "red", "blue", "green", "orange", "pink")

temp1 <- ggplot(false_positives, aes(x=new_bins)) + 
  geom_line(aes(y=FICO_FP_White, color="blue"))+
  geom_line(aes(y=FICO_FP_Hispanic, color="green"))+
  geom_line(aes(y=FICO_FP_Black, color="orange"))+
  geom_line(aes(y=FICO_FP_Asian, color="pink"))+
  xlab("FICO Score") + ylab("False Positive Rate")  + theme_classic() +
  scale_color_manual(name="Race",values=myColors, labels=c("White", "Hispanic", "Black", "Asian"))+
  scale_y_continuous(limits = c(0, .3),labels=percent)  

temp2 <- ggplot(false_positives, aes(x=new_bins)) + 
  geom_line(aes(y=ES_FP_White, color="blue"))+
  geom_line(aes(y=ES_FP_Hispanic, color="green"))+
  geom_line(aes(y=ES_FP_Black, color="orange"))+
  geom_line(aes(y= ES_FP_Asian , color="pink"))+
  xlab("FICO Score (EnergyScore Equivalent)") + ylab("False Positive Rate") + theme_classic() +
  scale_color_manual(name="Race",values=myColors, labels=c( "White", "Hispanic", "Black", "Asian"))+
  scale_y_continuous(limits = c(0, .3),labels=percent)  





```


```{r echo=FALSE, message=FALSE, warning=FALSE}
new_bins = seq(400,840,10)

false_positives <- joined %>%
  mutate(FICO_Bin = cut(FICOCLV8_SCORE, breaks=seq(400, 850, 10))) %>%
  filter(!is.na(FICO_Bin)) %>%
  filter(FICOCLV8_SCORE > 0) %>%
  group_by(FICO_Bin) %>%
  summarize(n=n())%>%
  mutate(new_bins = new_bins ) %>%
  select(new_bins, n) 
  
false_positives$ES_Cut <- NA
false_positives$FICO_FP <- NA

false_positives$FICO_FP_High<- NA
false_positives$FICO_FP_Medium <- NA
false_positives$FICO_FP_Low <- NA

false_positives$ES_FP <- NA
false_positives$ES_FP_High <- NA
false_positives$ES_FP_Medium <- NA
false_positives$ES_FP_Low <- NA


for (i in 1:length(false_positives$new_bins))
  
{
  false_positives$ES_Cut[i] <- quantile(joined$Prob_Not_Def,(1-(sum(joined$FICOCLV8_SCORE> false_positives$new_bins[i], na.rm=T)/sum(joined$FICOCLV8_SCORE>0, na.rm=T))))
  
  
  false_positives$FICO_FP[i] <- mean(joined$DPD90_KEYCD[joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  

  false_positives$FICO_FP_High[i] <- mean(joined$DPD90_KEYCD[joined$Income=="High" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  false_positives$FICO_FP_Medium[i] <- mean(joined$DPD90_KEYCD[joined$Income=="Medium" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  false_positives$FICO_FP_Low[i] <- mean(joined$DPD90_KEYCD[joined$Income=="Low" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  

  
}



for (i in 1:length(false_positives$new_bins))
  
{
  
  false_positives$ES_FP[i] <- mean(joined$DPD90_KEYCD[joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_High[i] <- mean(joined$DPD90_KEYCD[joined$Income=="High" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_Medium[i] <- mean(joined$DPD90_KEYCD[joined$Income=="Medium" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_Low[i] <- mean(joined$DPD90_KEYCD[joined$Income=="Low" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)

    
}
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
## only select FICO >=600
library(scales)
false_positives <- false_positives %>%
  filter(new_bins>590)

myColors <- c("darkgreen", "red", "green", "orange", "pink")

temp3 <- ggplot(false_positives, aes(x=new_bins)) + 
  geom_line(aes(y=FICO_FP_Low, color="green"))+
  geom_line(aes(y=FICO_FP_Medium, color="orange"))+
  geom_line(aes(y=FICO_FP_High, color="pink"))+
  xlab("FICO Score") + ylab("False Positive Rate") + theme_classic() +
  scale_color_manual(name="Income",values=myColors, labels=c("Low", "Medium", "High"))+
  scale_y_continuous(limits = c(0, .15),labels=percent) + theme(legend.title = element_blank())


temp4 <- ggplot(false_positives, aes(x=new_bins)) + 
  geom_line(aes(y=ES_FP_Low, color="green"))+
  geom_line(aes(y=ES_FP_Medium, color="orange"))+
  geom_line(aes(y=ES_FP_High, color="pink"))+
  xlab("FICO Score (EnergyScore Equivalent)") + ylab("False Positive Rate")  + theme_classic() +
  scale_color_manual(name="Income",values=myColors, labels=c( "Low", "Medium", "High"))+
  scale_y_continuous(limits = c(0, .15),labels=percent)





```



```{r fprace, echo=FALSE, fig.width=8,fig.height=6,fig.cap="\\label{fig:fprace}False Positive Comparison"}


grid.arrange(temp1, temp2, temp3, temp4, nrow=2, ncol=2)

combined_plot <- grid.arrange(temp1, temp2, temp3, temp4, nrow=2, ncol=2)

ggsave("whitepaper/figures/fig8.png",plot = combined_plot)

```



### HS and Education





#### Figure 9







```{r echo=FALSE, message=FALSE, warning=FALSE}
new_bins = seq(400,840,10)

false_positives <- joined %>%
  mutate(FICO_Bin = cut(FICOCLV8_SCORE, breaks=seq(400, 850, 10))) %>%
  filter(!is.na(FICO_Bin)) %>%
  filter(FICOCLV8_SCORE > 0) %>%
  group_by(FICO_Bin) %>%
  summarize(n=n())%>%
  mutate(new_bins = new_bins ) %>%
  select(new_bins, n) 
  
false_positives$ES_Cut <- NA
false_positives$FICO_FP <- NA

false_positives$FICO_FP_Rent <- NA
false_positives$FICO_FP_Own <- NA

false_positives$ES_FP <- NA
false_positives$ES_FP_Rent <- NA
false_positives$ES_FP_Own <- NA


for (i in 1:length(false_positives$new_bins))
  
{
  false_positives$ES_Cut[i] <- quantile(joined$Prob_Not_Def,(1-(sum(joined$FICOCLV8_SCORE> false_positives$new_bins[i], na.rm=T)/sum(joined$FICOCLV8_SCORE>0, na.rm=T))))
  
  
  false_positives$FICO_FP[i] <- mean(joined$DPD90_KEYCD[joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  
  false_positives$FICO_FP_Rent[i] <- mean(joined$DPD90_KEYCD[joined$HomeOwnership=="Rent" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  false_positives$FICO_FP_Own[i] <- mean(joined$DPD90_KEYCD[joined$HomeOwnership=="Own" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  


  
}



for (i in 1:length(false_positives$new_bins))
  
{
  
  false_positives$ES_FP[i] <- mean(joined$DPD90_KEYCD[joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_Rent[i] <- mean(joined$DPD90_KEYCD[joined$HomeOwnership=="Rent" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_Own[i] <- mean(joined$DPD90_KEYCD[joined$HomeOwnership=="Own" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  
}
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
## only select FICO >=600
library(scales)
false_positives <- false_positives %>%
  filter(new_bins>590)

myColors <- c("darkgreen", "red", "blue", "green")

temp1 <- ggplot(false_positives, aes(x=new_bins)) + 
  geom_line(aes(y=FICO_FP_Rent, color="blue"))+
  geom_line(aes(y=FICO_FP_Own, color="green"))+
  xlab("FICO Score") + ylab("False Positive Rate") +ggtitle("FICO") + theme_classic() +
  scale_color_manual(name="Homeownership",values=myColors, labels=c("Rent", "Own"))+
  scale_y_continuous(limits = c(0, .2),labels=percent) 


temp2 <- ggplot(false_positives, aes(x=new_bins)) + 
  geom_line(aes(y=ES_FP_Rent, color="blue"))+
  geom_line(aes(y=ES_FP_Own, color="green"))+
  xlab("FICO Score (EnergyScore Equivalent)") + ylab("False Positive Rate") +ggtitle("EnergyScore") + theme_classic() +
  scale_color_manual(name="Homeownership",values=myColors, labels=c("Rent", "Own"))+
  scale_y_continuous(limits = c(0, .2),labels=percent) 




```


```{r echo=FALSE, message=FALSE, warning=FALSE}
new_bins = seq(400,840,10)

false_positives <- joined %>%
  mutate(FICO_Bin = cut(FICOCLV8_SCORE, breaks=seq(400, 850, 10))) %>%
  filter(!is.na(FICO_Bin)) %>%
  filter(FICOCLV8_SCORE > 0) %>%
  group_by(FICO_Bin) %>%
  summarize(n=n())%>%
  mutate(new_bins = new_bins ) %>%
  select(new_bins, n) 
  
false_positives$ES_Cut <- NA
false_positives$FICO_FP <- NA
false_positives$FICO_FP_VT <- NA
false_positives$FICO_FP_HS <- NA
false_positives$FICO_FP_College <- NA
false_positives$FICO_FP_Grad <- NA


false_positives$ES_FP <- NA
false_positives$ES_FP_VT <- NA
false_positives$ES_FP_HS <- NA
false_positives$ES_FP_College <- NA
false_positives$ES_FP_Grad <- NA


for (i in 1:length(false_positives$new_bins))
  
{
  false_positives$ES_Cut[i] <- quantile(joined$Prob_Not_Def,(1-(sum(joined$FICOCLV8_SCORE> false_positives$new_bins[i], na.rm=T)/sum(joined$FICOCLV8_SCORE>0, na.rm=T))))
  
  
  false_positives$FICO_FP[i] <- mean(joined$DPD90_KEYCD[joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  
  false_positives$FICO_FP_VT[i] <- mean(joined$DPD90_KEYCD[joined$Education=="Vocational/Technical" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  false_positives$FICO_FP_HS[i] <- mean(joined$DPD90_KEYCD[joined$Education=="High School" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  false_positives$FICO_FP_College[i] <- mean(joined$DPD90_KEYCD[joined$Education=="College" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  
  false_positives$FICO_FP_Grad[i] <- mean(joined$DPD90_KEYCD[joined$Education=="Graduate School" & joined$FICOCLV8_SCORE >=false_positives$new_bins[i]], na.rm=T)
  

  
}



for (i in 1:length(false_positives$new_bins))
  
{
  
  false_positives$ES_FP[i] <- mean(joined$DPD90_KEYCD[joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_VT[i] <- mean(joined$DPD90_KEYCD[joined$Education=="Vocational/Technical" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_HS[i] <- mean(joined$DPD90_KEYCD[joined$Education=="High School" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_College[i] <- mean(joined$DPD90_KEYCD[joined$Education=="College" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  false_positives$ES_FP_Grad[i] <- mean(joined$DPD90_KEYCD[joined$Education=="Graduate School" & joined$Prob_Not_Def >=false_positives$ES_Cut[i]],na.rm=T)
  
}
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
## only select FICO >=600
library(scales)
false_positives <- false_positives %>%
  filter(new_bins>590)

myColors <- c("darkgreen", "red", "blue", "green", "orange", "pink")

temp3 <- ggplot(false_positives, aes(x=new_bins)) + 
  geom_line(aes(y=FICO_FP_VT, color="blue"))+
  geom_line(aes(y=FICO_FP_College, color="green"))+
  geom_line(aes(y=FICO_FP_HS, color="orange"))+
  geom_line(aes(y=FICO_FP_Grad, color="pink"))+
  xlab("FICO Score") + ylab("False Positive Rate") +ggtitle("FICO") + theme_classic() +
  scale_color_manual(name="Education",values=myColors, labels=c("Vocational/Technical", "College", "High School", "Graduate School"))+
  scale_y_continuous(limits = c(0, .12),labels=percent) 

temp4 <- ggplot(false_positives, aes(x=new_bins)) + 
  geom_line(aes(y=ES_FP_VT, color="blue"))+
  geom_line(aes(y=ES_FP_College, color="green"))+
  geom_line(aes(y=ES_FP_HS, color="orange"))+
  geom_line(aes(y=ES_FP_Grad, color="pink"))+
  xlab("FICO Score (EnergyScore Equivalent)") + ylab("False Positive Rate") +ggtitle("EnergyScore") + theme_classic() +
  scale_color_manual(name="Education",values=myColors, labels=c("Vocational/Technical", "College", "High School", "Graduate School"))+
  scale_y_continuous(limits = c(0, .12),labels=percent) 




```




```{r fprace2, echo=FALSE, fig.width=8,fig.height=6,fig.cap="\\label{fig:fprace2}False Positive Comparison, Continued"}


grid.arrange(temp1, temp2, temp3, temp4, nrow=2, ncol=2)

combined_plot <- grid.arrange(temp1, temp2, temp3, temp4, nrow=2, ncol=2)

ggsave("whitepaper/figures/fig9.png",plot = combined_plot)

```




